<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>易抽奖-抽奖</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="index.css" type="text/css">
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <script src="http://apps.bdimg.com/libs/angular.js/1.4.6/angular.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-lg-3 visible-xs-*"></div>
        <div class="col-lg-6" style="background-color:#DCDCDC"><br>
            <p class="font">活动名称</p>
            <div align="center">
                <p class="button3" id="lotteryname"></p>
                <img src="./images/timg.png" width="200px" ; height="200px" ; style="position:center; " id="img"/> <br><br>
                <button id="angle" class="button2 theme-benginlottery" onclick="doLottery()">抽奖</button>
                <br><br>
                <button class="button2">分享给小伙伴</button><br><br><br><br>
            </div>
            <!-- 初始页面展示 -->
            <div class="theme-popover">
                <div class="theme-poptit"><br>
                    <p class="font" id="again">请输入您的活动邀请码:</p>
                </div>
                <br>
                <div align="center">
                    <input class="input2" type="number" id="passcode"/><br><br><br><br>
                    <button class="button4 " id="yes">确定</button>
                    <button class="button5" onclick="window.open('index.html')">返回</button>
                </div>
            </div>
            <!-- 抽奖结果 -->
            <div class="theme-benginlottery">
                <div class="theme-popover2">
                    <div class="theme-poptit2"><br>
                        <p class="font">抽奖结果为：</p>
                    </div>
                    <br>
                    <div>
                        <p class="font" id="lotteryresult"></p><br><br>
                        <button class="button6" onclick="window.open('index.html')">返回主页</button>
                    </div>
                </div>
            </div>
            <!--页面灰色-->
            <div class="theme-popover-mask"></div>
        </div>
        <div class="col-lg-3 visible-xs-*"></div>
    </div>
</div>
</body>
<script>
    var getid = window.location.href.split('=')[1];
    $(document).ready(function () {
        // 跳转授权
        var APPID = "63b7b59e624425d0";
        var CALLBACK = "http://f.yiban.cn/iapp133683";
        var url = window.location.href;
// lottery     var vq = "0ce43a5c462ae07be4bf11527530e352fe38ee17abe082cf01397de62e38a06e73993ca948be9f04fc392f374399c545e0b1f532f9248705929846f3a65f10464b58b6a2841570f0ee9a8494455d0c9dfa2b37e50a787b8a5470dcfb3e59cc42b6df570b9352aa1196de9f5588add55f2fd079ffd3432dc91b522453a2719374b7934a5c2c102d0e758920ad46e94853d7347315ab5cc2c6e9fdd5f5210f96b53e36298baac038d42d9a6134c544e6e8f4b71f990caf14133396316007378c7deeab28d39312cbf44c9943570c1951cf719d7b8acc8cebcc9ae5a6a19b6372128716f6cbbe7b59a64d7fc103f6dd79db"
// 请销假        var vq = "c21f263641f5b94c0b20f9ec5d2ad13f5662aadf66899fbcc8eb82b1541e87bdb107f75ad2866ac7fbe01e756120b81e7ced4f9cc43d5a2dff1638bea54e97045febbeeb4acaacf9ba7b81ce69a0afe548b9b44daca8bbc24cb76e672e93b8af0bcb3e7b28985f58f1730ac4eff0928dde06e7df17d89eecc9c17d9f9d24bc8d87b56b877c35bc0d8efa901e5ac330388c50db352e4577678b92b4af2e5918a1defbae73ad711c907a8b7cf2343cfb4adad311336e1ede81e40cec8374e62de9cd90cc9335fd0367e863e0e6b241fc9bf5f70392cd013b0387f3d4e23b402651"
        var vq = window.location.href.split('=')[1];
        if (vq == null)
            window.location.href = "https://oauth.yiban.cn/code/html?client_id= " + APPID + " &redirect_uri=  " + CALLBACK + " &state=5050";
        else
            vq = window.location.href.split('=')[1].split('&')[0];

        // 获取token
        $.post("http://yb.upc.edu.cn:8084/auth",
            {
                appName: "石大请销假",
                vq: vq,
                device: "default"
            },
            function (data) {
                authtoken = data.token,
                    localStorage.setItem("testtoken", authtoken)
                getlottery();
            });
    });
    var token = localStorage.getItem("testtoken")


    //初始页面展示
        $('.theme-popover-mask').fadeIn(100);
        $('.theme-popover').slideDown(200);
        //展示抽奖名称
        $.post("http://yb.upc.edu.cn:8084/lottery/findone",
            {
                Authorization: localStorage.getItem("testtoken"),
                lotteryId: getid
            },
            function (data) {
                document.getElementById("lotteryname").innerHTML = data.object.lotteryname
            })

        //关闭框
        function guan() {
            $('.theme-popover-mask').fadeOut(100);
            $('.theme-popover').slideUp(200);
        }

        //判断抽奖码是否正确
        $("button#yes").click(function () {
            $.post("http://yb.upc.edu.cn:8084/lottery/ispass",
                {
                    Authorization: localStorage.getItem("testtoken"),
                    lotteryId: getid,
                    passcode: document.getElementById('passcode').value
                },
                function (data) {
                    if (data.code == 1) {
                        guan()
                    }
                    //不正确时展示重新输入
                    else {
                        $('p#again').text("输入错误!请再次输入:")
                        $('input#passcode').val("");
                    }
                })
        })
        //旋转图片
        var deg = 0;
        document.getElementById("angle").onclick = function () {
            deg += 145;
            document.getElementById("img").style.transform = "rotate(" + deg + "deg)";
            doLottery()
        }

        //抽奖按钮弹出框展示奖品
        function doLottery() {
            $('.theme-popover-mask').fadeIn(100);
            $('.theme-popover2').slideDown(200);

            $.get("http://yb.upc.edu.cn:8084/lottery/dolottery",
                {
                    Authorization: localStorage.getItem("testtoken"),
                    lotteryId: getid
                },
                function (data) {

                    message = data.msg
                    if (data.code == -1) {
                        document.getElementById("lotteryresult").innerHTML = message
                    }
                    else if (data.code == 0)
                        document.getElementById("lotteryresult").innerHTML = "抽奖出错，请稍候再来~"
                    else if (data.code == -2)
                        document.getElementById("lotteryresult").innerHTML = message
                    else
                        document.getElementById("lotteryresult").innerHTML = "恭喜你获得:<br>" + data.object.prizeName
                }
            )
        }
</script>
</html>


